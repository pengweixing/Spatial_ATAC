
#!/bin/bash
## generated by xingqi chen xingqi@stanford.edu

## calculate how many CPU could be used
FILES=*_R1_001.trim.fastq.gz
i=0
for f in $FILES
do
 i=$[$i+1]
done
count=$[$i*20]


## head for configuration file
refrence_genome=$1
echo $refrence_genome
if [[ "$refrence_genome" == "mm" ]]
then  

# echo "## this is for mouse configuration" >>configuration_test.txt
 echo "ref_index=/disk1/pengweixing/database/mm10/bowtie2/mm10">>configuration_test.txt
 echo "ref_size=/disk1/pengweixing/database/mm10/mm10.chrom.sizes">>configuration_test.txt
 echo "max_thread=$count">>configuration_test.txt
 echo "gsize=mm">>configuration_test.txt
elif [[ "$refrence_genome" == "hs" ]] >>configuration_test.txt
then
# echo "## this is for human configuration">>configuration_test.txt
 echo "ref_index=/disk1/pengweixing/database/hg38/index/hg38.fa">>configuration_test.txt
 echo "ref_size=/disk1/pengweixing/database/hg38/hg38.chrom.sizes">>configuration_test.txt
 echo "max_thread=$count">>configuration_test.txt
 echo "gsize=hs">>configuration_test.txt
fi

## add the file name and path 
FILES=*_R1_001.trim.fastq.gz
for  f in  $FILES
do
 echo $PWD/$f    $PWD/$(basename $f _R1_001.trim.fastq.gz)_R2_001.trim.fastq.gz    $PWD    $(basename $f _R1_001.trim.fastq.gz) >>configuration_test.txt 
done


## replace all white space with tabs

tr ' ' \\t <configuration_test.txt >configure.txt
rm configuration_test.txt

echo "configuration file is done, created by xingqi"



	perl /disk1/pengweixing/pipeline/atac/test_bulk.pl configure.txt

echo "finish configuration file"

#### mapping
FILES=*.sh

for f in $FILES
do

./$f 1>./$f.log 2>./$f.err


echo "$f done with mapping"

done

## qcTable
 python /disk1/pengweixing/pipeline/spatial_atac/getQCTable_test.py -i  configure.txt

echo " qctable is done"
